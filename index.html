<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Interactive Political Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <!-- Toggle Button -->
    <button id="toggleForm">➕ Add Politician</button>

    <!-- Hidden Add Form -->
    <div id="controls">
      <input type="text" id="nameInput" placeholder="name" />
      <input type="text" id="imgInput" placeholder="image link (URL)" />
      <input type="text" id="titleInput" placeholder="title" />
      <select id="roleInput">
        <option value="" disabled selected hidden>role</option>
        <option value="member">member</option>
        <option value="leader">leader</option>
      </select>
      <button class="addBtn" onclick="addPoliticianFromForm()">Add</button>
    </div>

    <!-- Map -->
    <div id="map"></div>

    <!-- Info Modal -->
    <div id="infoModal">
      <div id="infoContent">
        <button id="closeInfo">✖</button>
        <img id="infoImage" src="" alt="portrait" />
        <h2 id="infoName"></h2>
        <h4 id="infoTitle"></h4>
      </div>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
      // Toggle Form Visibility
      const toggleBtn = document.getElementById("toggleForm");
      const controls = document.getElementById("controls");
      toggleBtn.onclick = () => {
        controls.classList.toggle("show");
        toggleBtn.textContent = controls.classList.contains("show")
          ? "✖ Close Form"
          : "➕ Add Politician";
      };

      // Map setup
      const map = L.map("map", {
        maxBounds: [
          [-85, -180],
          [85, 180],
        ],
        maxBoundsViscosity: 1.0,
      }).setView([20, 0], 2);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "© OpenStreetMap contributors",
        noWrap: true,
        minZoom: 3,
      }).addTo(map);

      const politicianMarkers = [];

      // Icon creator (role controls border color)
      function createPoliticianIcon(
        imageUrl,
        zoomLevel,
        name,
        role = "member"
      ) {
        const size = zoomLevel * 3 + 20;
        const borderColor =
          role === "leader" ? "gold" : role === "army" ? "green" : "#333";
        const borderWidth =
          role === "leader" ? "4px" : role === "army" ? "3px" : "2px";
        return L.divIcon({
          html: `<div class="politician-icon"
                      style="width:${size}px;height:${size}px;border:${borderWidth} solid ${borderColor};"
                      title="${name}">
                    <img src="${imageUrl}" />
                 </div>`,
          className: "",
          iconSize: [size, size],
        });
      }

      // Modal logic
      const modal = document.getElementById("infoModal");
      const closeBtn = document.getElementById("closeInfo");
      function showInfoModal(name, imageUrl, title) {
        document.getElementById("infoName").textContent = name;
        document.getElementById("infoTitle").textContent = title || "";
        document.getElementById("infoImage").src = imageUrl;
        modal.classList.add("show");
      }
      function hideInfoModal() {
        modal.classList.remove("show");
      }
      closeBtn.onclick = hideInfoModal;
      modal.addEventListener("click", (e) => {
        if (e.target === modal) hideInfoModal();
      });
      window.addEventListener("keydown", (e) => {
        if (e.key === "Escape") hideInfoModal();
      });

      // Add politician
      function addPolitician(
        lat,
        lng,
        name,
        imageUrl,
        role = "member",
        title = ""
      ) {
        const marker = L.marker([lat, lng], {
          icon: createPoliticianIcon(imageUrl, map.getZoom(), name, role),
          draggable: true,
          zIndexOffset: role === "leader" ? 1000 : 0,
        }).addTo(map);

        marker.on("click", () => showInfoModal(name, imageUrl, title));

        politicianMarkers.push({ marker, imageUrl, name, role, title });
      }

      function addPoliticianFromForm() {
        const name = document.getElementById("nameInput").value || "no name";
        const img =
          document.getElementById("imgInput").value ||
          "https://upload.wikimedia.org/wikipedia/commons/9/99/Sample_User_Icon.png";
        const title = document.getElementById("titleInput").value || "";
        const role = document.getElementById("roleInput").value || "member";

        addPolitician(20, 0, name, img, role, title);

        document.getElementById("nameInput").value = "";
        document.getElementById("imgInput").value = "";
        document.getElementById("titleInput").value = "";
        document.getElementById("roleInput").selectedIndex = 0;
      }

      // Resize on zoom
      map.on("zoom", () => {
        const zoomLevel = map.getZoom();
        politicianMarkers.forEach((p) => {
          p.marker.setIcon(
            createPoliticianIcon(p.imageUrl, zoomLevel, p.name, p.role)
          );
        });
      });

      // Initial politicians
      const initialPoliticians = [
        {
          name: "Donald Trump",
          lat: 38.9,
          lng: -77.03,
          imageUrl: "img/Donald_Trump.jpg",
          role: "leader",
          title: "President of the United States",
        },
        {
          name: "Xi Jinping",
          lat: 39.9,
          lng: 116.4,
          imageUrl: "img/Xi_Jinping.jpg",
          role: "leader",
          title: "President of China",
        },
        {
          name: "Abdul-Malik al-Houthi",
          lat: 15.35,
          lng: 44.21,
          imageUrl: "img/Abdul_Malik_al_Houthi.jpg",
          role: "leader",
          title: "Leader of Ansar Allah",
        },
      ];
      initialPoliticians.forEach((p) =>
        addPolitician(p.lat, p.lng, p.name, p.imageUrl, p.role, p.title)
      );
    </script>
    <script>
      fetch("politicians.json")
        .then((response) => response.json())
        .then((data) => {
          data.forEach((p) => {
            addPolitician(p.lat, p.lng, p.name, p.imageUrl, p.role, p.title);
          });
        })
        .catch((error) => console.error("error", error));

      fetch("nato-countries.json")
        .then((response) => response.json())
        .then((data) => {
          L.geoJSON(data, {
            style: {
              fillColor: "blue",
              weight: 2,
              color: "white",
              fillOpacity: 0.6,
            },
            interactive: false,
          }).addTo(map);
        });
    </script>
    <script>
      // calculate vh in devices
      function setVh() {
        document.documentElement.style.setProperty(
          "--vh",
          `${window.innerHeight * 0.01}px`
        );
      }
      setVh();
      window.addEventListener("resize", setVh);
    </script>
  </body>
</html>
